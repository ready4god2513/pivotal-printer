<form action="/" method="GET" class="well form-search" id="search-form">
	<input type="text" class="input-large search-query" placeholder="Search Pivotal Stories">
	<button type="submit" class="btn">Search</button>
</form>

<div id="pivotal-projects">
	<h4 id="waiting">Fetching stories from Pivotal...</h4>
	<h4 id="number-of-results"></h4>
	<ul class="thumbnails"></ul>
</div>

<script type="text/html" id="story">
	<li class="span6">
		<div class="thumbnail">
			<header class="row">
				<div class="span4">
					<h5>
						<span class="label" data-story-type="{{ story_type }}">{{ story_type }}</span> 
						<span data-story-name="{{ name }}">{{ name }}</span>
					</h5>
					<h5 data-story-owner="{{ owned_by }}">
						<span class="label label-info">Owner</span>
						{{ owned_by }}
					</h5>
				</div>
				<h6 class="pull-right">
					<span data-story-estimate="{{ estimate }}">{{ estimate }}</span>
					<span class="label label-state" data-story-current-state="{{ current_state }}">{{ current_state }}</span>
				</h6>
			</header>
			<p class="story-description">{{ description }}</p>
		</div>
	</li>
</script>

<script>
	var stories = new Backbone.Collection;
	
	stories.fetch({
		url: "/stories",
		success: function()
		{
			$("#waiting").fadeOut("normal", function(){
				$(this).remove();
			});
		}
	});
	
	$("#search-form").on("submit", function(){
		var display = $("#pivotal-projects ul.thumbnails");
		var result_count = $("#pivotal-projects #number-of-results");
		
		display.html("Searching...");
		var res = stories.filter(function(story)
		{
			return story.attributes.name.toLowerCase().indexOf($("#search-form .search-query").val().toLowerCase()) != -1;
		});
		
		if(res.length > 0)
		{
			result_count.html(res.length + " stories found");
			display.html("");
			_.each(res, function(story){
				display.append(ich.story(story.attributes));
			});
		}
		else
		{
			display.html("");
			result_count.html("No results found");
		}
		
		
		return false;
	});
</script>